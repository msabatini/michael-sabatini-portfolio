<div class="dashboard-container fade-in-animation">
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Admin Dashboard</h1>
        <nav class="dashboard-tabs">
          <button 
            [class.active]="activeTab() === 'analytics'" 
            (click)="setTab('analytics')">
            <app-icon name="chart" [size]="18"></app-icon>
            Analytics
          </button>
          <button 
            [class.active]="activeTab() === 'projects'" 
            (click)="setTab('projects')">
            <app-icon name="briefcase" [size]="18"></app-icon>
            Projects
          </button>
          <button 
            [class.active]="activeTab() === 'messages'" 
            (click)="setTab('messages')">
            <app-icon name="mail" [size]="18"></app-icon>
            Messages
            @if (unreadCount() > 0) {
              <span class="tab-badge">{{ unreadCount() }}</span>
            }
          </button>
          <button 
            [class.active]="activeTab() === 'settings'" 
            (click)="setTab('settings')">
            <app-icon name="settings" [size]="18"></app-icon>
            Settings
          </button>
          <button 
            [class.active]="activeTab() === 'media'" 
            (click)="setTab('media')">
            <app-icon name="image" [size]="18"></app-icon>
            Media
          </button>
          <button 
            [class.active]="activeTab() === 'help'" 
            (click)="setTab('help')">
            <app-icon name="help" [size]="18"></app-icon>
            Help
          </button>
        </nav>
      </div>
      <div class="header-actions">
        @if (activeTab() === 'analytics') {
          <button (click)="loadStats()" class="btn btn-outline btn-sm">Refresh</button>
        } @else if (activeTab() === 'projects') {
          <button (click)="openForm()" class="btn btn-primary btn-sm">
            <app-icon name="plus" [size]="16"></app-icon>
            New Project
          </button>
        } @else if (activeTab() === 'messages') {
          <button (click)="loadMessages()" class="btn btn-outline btn-sm">Refresh</button>
        } @else if (activeTab() === 'media') {
          <label class="btn btn-primary btn-sm" style="cursor: pointer;">
            <app-icon name="upload" [size]="16"></app-icon>
            Upload Media
            <input type="file" (change)="onFileUpload($event)" style="display: none;" accept="image/*">
          </label>
        } @else {
          <button (click)="saveSettings()" class="btn btn-primary btn-sm">
            <app-icon name="save" [size]="16"></app-icon>
            Save Settings
          </button>
        }
        <button (click)="logout()" class="btn btn-outline btn-sm">Logout</button>
      </div>
    </div>
  </header>

  <div class="dashboard-content">
    @if (activeTab() === 'analytics') {
      <div class="analytics-controls data-table-card">
        <div class="control-group">
          <label>Date Range</label>
          <div class="presets">
            <button (click)="setDatePreset(0)" class="btn btn-xs" [class.active]="dateRange().start === dateRange().end">Today</button>
            <button (click)="setDatePreset(7)" class="btn btn-xs">7d</button>
            <button (click)="setDatePreset(30)" class="btn btn-xs">30d</button>
          </div>
          <div class="date-inputs">
            <input type="date" [value]="dateRange().start" (change)="updateDateRange($any($event.target).value, dateRange().end)">
            <span>to</span>
            <input type="date" [value]="dateRange().end" (change)="updateDateRange(dateRange().start, $any($event.target).value)">
          </div>
        </div>
        <div class="control-group">
          <label>Device</label>
          <select (change)="updateFilter('device', $any($event.target).value)">
            <option value="">All</option>
            <option value="Desktop">Desktop</option>
            <option value="Mobile">Mobile</option>
            <option value="Tablet">Tablet</option>
          </select>
        </div>
        <div class="control-group">
          <label>Campaign</label>
          <select (change)="updateFilter('campaign', $any($event.target).value)">
            <option value="">All</option>
            @for (utm of stats()?.utmStats; track utm.campaign) {
              @if (utm.campaign) {
                <option [value]="utm.campaign">{{ utm.campaign }}</option>
              }
            }
          </select>
        </div>
        <div class="control-group">
          <label>Location</label>
          <select (change)="updateFilter('location', $any($event.target).value)">
            <option value="">All</option>
            @for (loc of stats()?.locationStats; track loc.name) {
              <option [value]="loc.name">{{ loc.name }}</option>
            }
          </select>
        </div>
        <div class="control-actions">
          <button (click)="toggleCompare()" class="btn btn-sm" [class.btn-primary]="compareEnabled()" [class.btn-outline]="!compareEnabled()">
            <app-icon name="copy" [size]="14"></app-icon> Compare
          </button>
          <button (click)="toggleLiveMode()" class="btn btn-sm" [class.btn-primary]="isLiveMode()" [class.btn-outline]="!isLiveMode()">
            <app-icon name="activity" [size]="14"></app-icon> Live
          </button>
          <button (click)="exportPDF()" class="btn btn-outline btn-sm">
            <app-icon name="file-text" [size]="14"></app-icon> PDF
          </button>
          <button (click)="downloadCSV('pages')" class="btn btn-outline btn-sm">
            <app-icon name="download" [size]="14"></app-icon> Export CSV
          </button>
        </div>
      </div>

      @if (analyticsFilters().path) {
        <div class="active-filters">
          <span class="filter-tag">
            Path: {{ analyticsFilters().path }}
            <button (click)="updateFilter('path', '')"><app-icon name="x" [size]="12"></app-icon></button>
          </span>
        </div>
      }

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Views</h3>
          <p class="stat-value">{{ stats()?.totalViews || 0 }}</p>
          <div class="stat-meta">
            <span class="stat-label">Pageviews</span>
            @if (compareEnabled() && stats()?.comparison?.totalViews) {
              <span class="comparison" [class]="getChangeClass(stats()?.comparison?.totalViews)">
                <app-icon [name]="getChangeIcon(stats()?.comparison?.totalViews)" [size]="12"></app-icon>
                {{ stats()?.comparison?.totalViews }}%
              </span>
            }
          </div>
        </div>
        <div class="stat-card">
          <h3>Unique Visitors</h3>
          <p class="stat-value">{{ stats()?.uniqueVisitors || 0 }}</p>
          <div class="stat-meta">
            <span class="stat-label">Visitors</span>
            @if (compareEnabled() && stats()?.comparison?.uniqueVisitors) {
              <span class="comparison" [class]="getChangeClass(stats()?.comparison?.uniqueVisitors)">
                <app-icon [name]="getChangeIcon(stats()?.comparison?.uniqueVisitors)" [size]="12"></app-icon>
                {{ stats()?.comparison?.uniqueVisitors }}%
              </span>
            }
          </div>
        </div>
        <div class="stat-card">
          <h3>Bounce Rate</h3>
          <p class="stat-value">{{ stats()?.engagementMetrics?.bounceRate || 0 }}%</p>
          <div class="stat-meta">
            <span class="stat-label">Single page sessions</span>
            @if (compareEnabled() && stats()?.comparison?.bounceRate) {
              <span class="comparison invert" [class]="getChangeClass(stats()?.comparison?.bounceRate)">
                <app-icon [name]="getChangeIcon(stats()?.comparison?.bounceRate)" [size]="12"></app-icon>
                {{ stats()?.comparison?.bounceRate }}%
              </span>
            }
          </div>
        </div>
        <div class="stat-card">
          <h3>Engagement</h3>
          <p class="stat-value">{{ stats()?.engagementMetrics?.engagementRate || 0 }}%</p>
          <div class="stat-meta">
            <span class="stat-label">Engaged sessions</span>
            @if (compareEnabled() && stats()?.comparison?.engagementRate) {
              <span class="comparison" [class]="getChangeClass(stats()?.comparison?.engagementRate)">
                <app-icon [name]="getChangeIcon(stats()?.comparison?.engagementRate)" [size]="12"></app-icon>
                {{ stats()?.comparison?.engagementRate }}%
              </span>
            }
          </div>
        </div>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Sessions</h3>
          <p class="stat-value">{{ stats()?.trafficMetrics?.totalSessions || 0 }}</p>
          <span class="stat-label">{{ stats()?.trafficMetrics?.sessionsPerUser || 0 }} per user</span>
        </div>
        <div class="stat-card">
          <h3>Avg. Session</h3>
          <p class="stat-value">{{ stats()?.avgSessionDuration || '0:00' }}</p>
          <span class="stat-label">{{ stats()?.trafficMetrics?.pagesPerSession || 0 }} pages/session</span>
        </div>
        <div class="stat-card">
          <h3>Top Scroll</h3>
          <p class="stat-value">75%</p>
          <span class="stat-label">Avg. scroll depth</span>
        </div>
        <div class="stat-card">
          <h3>Interactions</h3>
          <p class="stat-value">{{ stats()?.interactions?.length || 0 }}</p>
          <span class="stat-label">Unique events</span>
        </div>
      </div>

      <div class="stats-sections secondary-stats">
        <div class="data-table-card">
          <h2>Core Web Vitals</h2>
          <div class="vitals-grid">
            <div class="vital-item" [class]="getVitalsScore('lcp', stats()?.performanceMetrics?.lcp)">
              <span class="label">LCP</span>
              <span class="value">{{ stats()?.performanceMetrics?.lcp || 0 }}ms</span>
            </div>
            <div class="vital-item" [class]="getVitalsScore('fid', stats()?.performanceMetrics?.fid)">
              <span class="label">FID</span>
              <span class="value">{{ stats()?.performanceMetrics?.fid || 0 }}ms</span>
            </div>
            <div class="vital-item" [class]="getVitalsScore('cls', stats()?.performanceMetrics?.cls)">
              <span class="label">CLS</span>
              <span class="value">{{ stats()?.performanceMetrics?.cls || 0 }}</span>
            </div>
            <div class="vital-item">
              <span class="label">TTFB</span>
              <span class="value">{{ stats()?.performanceMetrics?.ttfb || 0 }}ms</span>
            </div>
          </div>
          <div class="stat-card mini" style="margin-top: 1rem; box-shadow: none;">
            <h3>Avg. Load Time</h3>
            <p class="stat-value" style="font-size: 1.5rem;">{{ (stats()?.performanceMetrics?.load_time / 1000).toFixed(2) }}s</p>
          </div>
        </div>

        <div class="data-table-card">
          <h2>Tech Breakdown</h2>
          <div class="tech-grid">
            <div class="tech-section">
              <h3>Operating System</h3>
              @for (os of stats()?.techBreakdown?.os; track os.name) {
                <div class="tech-item">
                  <span>{{ os.name }}</span>
                  <span>{{ os.count }}</span>
                </div>
              }
            </div>
            <div class="tech-section">
              <h3>Resolution</h3>
              @for (res of stats()?.techBreakdown?.resolution; track res.name) {
                <div class="tech-item">
                  <span>{{ res.name }}</span>
                  <span>{{ res.count }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="stats-sections secondary-stats">
        <div class="data-table-card">
          <h2>User Flows (Top Sequences)</h2>
          <div class="flow-list">
            @for (flow of stats()?.uxMetrics?.topFlows; track flow.flow) {
              <div class="flow-item">
                <div class="flow-path">{{ flow.flow }}</div>
                <div class="flow-count">{{ flow.count }} sessions</div>
              </div>
            }
          </div>
        </div>

        <div class="data-table-card">
          <h2>UX Frustration (Rage Clicks)</h2>
          @if (stats()?.uxMetrics?.rageClicks?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Element</th>
                  <th>Page</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                @for (rage of stats()?.uxMetrics?.rageClicks; track rage.element) {
                  <tr>
                    <td><span class="status-badge error">{{ rage.element }}</span></td>
                    <td>{{ rage.path }}</td>
                    <td>{{ rage.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No rage clicks detected</div>
          }
        </div>
      </div>

      @if (stats()?.errorMetrics?.length > 0) {
        <div class="data-table-card error-log">
          <h2>Error Log (Recent)</h2>
          <table class="data-table">
            <thead>
              <tr>
                <th>Type</th>
                <th>Message</th>
                <th>Count</th>
              </tr>
            </thead>
            <tbody>
              @for (error of stats()?.errorMetrics; track error.message) {
                <tr>
                  <td><span class="status-badge error">{{ error.type.replace('error_', '') }}</span></td>
                  <td class="error-msg-cell">{{ error.message }}</td>
                  <td>{{ error.count }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }

      <div class="stats-sections secondary-stats">
        <div class="data-table-card">
          <h2>Acquisition Channels</h2>
          <div class="channel-stats">
            @for (source of stats()?.acquisitionSources; track source.name) {
              @if (source.count > 0) {
                <div class="channel-item">
                  <div class="channel-info">
                    <span class="channel-name">{{ source.name }}</span>
                    <span class="channel-value">{{ source.count }}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="(source.count / stats()?.totalViews) * 100"></div>
                  </div>
                </div>
              }
            }
          </div>
        </div>

        <div class="data-table-card">
          <h2>New vs Returning</h2>
          <div class="user-split">
            <div class="split-item">
              <span class="label">New Visitors</span>
              <span class="value">{{ stats()?.trafficMetrics?.newUsers || 0 }}</span>
              <div class="progress-bar mini">
                <div class="progress-fill new" [style.width.%]="(stats()?.trafficMetrics?.newUsers / stats()?.uniqueVisitors) * 100"></div>
              </div>
            </div>
            <div class="split-item">
              <span class="label">Returning</span>
              <span class="value">{{ stats()?.trafficMetrics?.returningUsers || 0 }}</span>
              <div class="progress-bar mini">
                <div class="progress-fill returning" [style.width.%]="(stats()?.trafficMetrics?.returningUsers / stats()?.uniqueVisitors) * 100"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="data-table-card">
          <h2>Scroll Depth</h2>
          <div class="scroll-stats">
            @for (depth of [25, 50, 75, 100]; track depth) {
              <div class="scroll-item">
                <span class="label">{{ depth }}% Depth</span>
                <div class="progress-bar">
                  <div class="progress-fill" [style.width.%]="getScrollPercent(depth)"></div>
                </div>
              </div>
            }
          </div>
        </div>

        <div class="data-table-card">
          <h2>Exit Pages</h2>
          @if (stats()?.engagementMetrics?.exitStats?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Page</th>
                  <th>Exits</th>
                  <th>Exit Rate</th>
                </tr>
              </thead>
              <tbody>
                @for (exit of stats()?.engagementMetrics?.exitStats; track exit.path) {
                  <tr>
                    <td>{{ exit.path }}</td>
                    <td>{{ exit.count }}</td>
                    <td>{{ exit.rate }}%</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No exit data yet</div>
          }
        </div>
      </div>

      <div class="chart-section data-table-card">
        <div class="chart-header">
          <h2>Activity Timeline</h2>
          <button (click)="addNote()" class="btn btn-xs btn-outline">
            <app-icon name="plus" [size]="12"></app-icon> Add Note
          </button>
        </div>
        @if (stats()?.dailyActivity?.length > 0) {
          <div class="bar-chart">
            @for (day of stats()?.dailyActivity; track day.date) {
              <div class="bar-group">
                <div class="bar-container">
                  @if (getNoteForDate(day.date); as note) {
                    <div class="chart-annotation" [attr.title]="note.content" (click)="deleteNote(note.id)">
                      <app-icon name="info" [size]="14"></app-icon>
                    </div>
                  }
                  <div class="bar" 
                    [style.height]="((day.count / getMaxActivity()) * 100) + '%'"
                    [attr.title]="day.count + ' views'">
                    <span class="bar-tooltip">{{ day.count }}</span>
                  </div>
                </div>
                <span class="bar-label">{{ day.date }}</span>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">No activity data yet</div>
        }
      </div>

      <div class="data-table-card share-management">
        <div class="card-header">
          <h2>Dashboard Sharing Links</h2>
          <button (click)="createShareLink()" class="btn btn-primary btn-sm">
            <app-icon name="share" [size]="16"></app-icon> Create New Link
          </button>
        </div>
        @if (shareLinks().length > 0) {
          <table class="data-table">
            <thead>
              <tr>
                <th>Label</th>
                <th>Created</th>
                <th>Expires</th>
                <th class="actions-cell">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (share of shareLinks(); track share.id) {
                <tr>
                  <td><strong>{{ share.label || 'Unnamed Share' }}</strong></td>
                  <td>{{ share.createdAt | date:'shortDate' }}</td>
                  <td>{{ share.expiresAt ? (share.expiresAt | date:'shortDate') : 'Never' }}</td>
                  <td class="actions-cell">
                    <button (click)="copyShareLink(share.token)" class="btn btn-xs btn-outline" style="margin-right: 0.5rem;">
                      <app-icon name="copy" [size]="14"></app-icon> Copy Link
                    </button>
                    <button (click)="deleteShareLink(share.id)" class="icon-btn delete">
                      <app-icon name="trash" [size]="16"></app-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="empty-state">No sharing links created yet</div>
        }
      </div>

      <div class="data-table-card api-key-management">
        <div class="card-header">
          <h2>API Access Keys</h2>
          <button (click)="createApiKey()" class="btn btn-primary btn-sm">
            <app-icon name="plus" [size]="16"></app-icon> Generate Key
          </button>
        </div>
        @if (apiKeys().length > 0) {
          <table class="data-table">
            <thead>
              <tr>
                <th>Label</th>
                <th>API Key</th>
                <th>Last Used</th>
                <th class="actions-cell">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (key of apiKeys(); track key.id) {
                <tr>
                  <td><strong>{{ key.label }}</strong></td>
                  <td><code>{{ key.key.substring(0, 8) }}...</code></td>
                  <td>{{ key.lastUsedAt ? (key.lastUsedAt | date:'short') : 'Never' }}</td>
                  <td class="actions-cell">
                    <button (click)="copyApiKey(key.key)" class="btn btn-xs btn-outline" style="margin-right: 0.5rem;">
                      <app-icon name="copy" [size]="14"></app-icon> Copy
                    </button>
                    <button (click)="deleteApiKey(key.id)" class="icon-btn delete">
                      <app-icon name="trash" [size]="16"></app-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="empty-state">No API keys generated yet</div>
        }
      </div>

      <div class="stats-sections">
        <div class="data-table-card">
          <h2>Top Pages</h2>
          @if (stats()?.topPages?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Page Path</th>
                  <th>Views</th>
                  <th style="width: 150px;">Popularity</th>
                </tr>
              </thead>
              <tbody>
                @for (page of stats()?.topPages; track page.path) {
                  <tr>
                    <td>
                      <a href="javascript:void(0)" (click)="updateFilter('path', page.path)" class="drill-down-link">
                        {{ page.path }}
                      </a>
                    </td>
                    <td>{{ page.count }}</td>
                    <td>
                      <div class="progress-bar">
                        <div class="progress-fill" [style.width.%]="(page.count / stats()?.totalViews) * 100"></div>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No page data yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Project Engagement</h2>
          @if (stats()?.topProjects?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Project</th>
                  <th>Views</th>
                </tr>
              </thead>
              <tbody>
                @for (project of stats()?.topProjects; track project.path) {
                  <tr>
                    <td>
                      <a href="javascript:void(0)" (click)="updateFilter('path', project.path)" class="drill-down-link">
                        {{ project.path.replace('/projects/', '') || 'All' }}
                      </a>
                    </td>
                    <td>{{ project.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No project views yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Top Referrers</h2>
          @if (stats()?.topReferrers?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Source</th>
                  <th>Views</th>
                </tr>
              </thead>
              <tbody>
                @for (ref of stats()?.topReferrers; track ref.referrer) {
                  <tr>
                    <td>{{ ref.referrer }}</td>
                    <td>{{ ref.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No referrer data yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Top Locations</h2>
          @if (stats()?.locationStats?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>City / Country</th>
                  <th>Visitors</th>
                </tr>
              </thead>
              <tbody>
                @for (loc of stats()?.locationStats; track loc.name) {
                  <tr>
                    <td>{{ loc.name }}</td>
                    <td>{{ loc.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No location data yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Browser Usage</h2>
          @if (stats()?.browsers?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Browser</th>
                  <th>Count</th>
                </tr>
              </thead>
              <tbody>
                @for (browser of stats()?.browsers; track browser.name) {
                  <tr>
                    <td>{{ browser.name }}</td>
                    <td>{{ browser.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No browser data yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Device Usage</h2>
          <div class="device-stats">
            @if (stats()?.deviceStats?.length > 0) {
              @for (device of stats()?.deviceStats; track device.name) {
                <div class="device-item">
                  <app-icon [name]="device.name === 'Desktop' ? 'monitor' : (device.name === 'Mobile' ? 'smartphone' : 'tablet')" [size]="20"></app-icon>
                  <div class="device-info">
                    <span class="device-name">{{ device.name || 'Unknown' }}</span>
                    <div class="progress-bar">
                      <div class="progress-fill" [style.width.%]="(device.count / stats()?.totalViews) * 100"></div>
                    </div>
                  </div>
                  <span class="device-value">{{ ((device.count / stats()?.totalViews) * 100).toFixed(0) }}%</span>
                </div>
              }
            } @else {
              <div class="empty-state">No device data yet</div>
            }
          </div>
        </div>

        <div class="data-table-card">
          <div class="card-header">
            <h2>Campaign Traffic (UTM)</h2>
            <button (click)="downloadCSV('utm')" class="icon-btn" title="Download CSV">
              <app-icon name="download" [size]="14"></app-icon>
            </button>
          </div>
          @if (stats()?.utmStats?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Campaign</th>
                  <th>Source / Medium</th>
                  <th>Views</th>
                </tr>
              </thead>
              <tbody>
                @for (utm of stats()?.utmStats; track $index) {
                  <tr>
                    <td>{{ utm.campaign || 'None' }}</td>
                    <td>{{ utm.source }} / {{ utm.medium || 'direct' }}</td>
                    <td>{{ utm.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No campaign data yet</div>
          }
        </div>

        <div class="data-table-card">
          <h2>Key Interactions</h2>
          @if (stats()?.interactions?.length > 0) {
            <table class="data-table">
              <thead>
                <tr>
                  <th>Action</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                @for (item of stats()?.interactions; track item.name) {
                  <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.count }}</td>
                  </tr>
                }
              </tbody>
            </table>
          } @else {
            <div class="empty-state">No interactions yet</div>
          }
        </div>

        <div class="data-table-card full-width">
          <h2>Business Intelligence & Advanced Analytics</h2>
          <div class="advanced-grid">
            <div class="advanced-card">
              <h3>Weekly Retention (Cohorts)</h3>
              <div class="cohort-table">
                <div class="cohort-header">
                  <span>Cohort</span>
                  <span>Size</span>
                  <span>Retention (Wk 1)</span>
                </div>
                @for (cohort of stats()?.advancedMetrics?.cohorts; track cohort.week) {
                  <div class="cohort-row">
                    <span>{{ cohort.week }}</span>
                    <span>{{ cohort.size }}</span>
                    <div class="retention-container">
                      <div class="retention-bar" [style.width.%]="cohort.retention"></div>
                      <span class="retention-val">{{ cohort.retention }}%</span>
                    </div>
                  </div>
                }
              </div>
            </div>

            <div class="advanced-card">
              <h3>User Personas</h3>
              <div class="persona-list">
                @for (segment of stats()?.advancedMetrics?.segments; track segment.name) {
                  <div class="persona-item">
                    <div class="persona-info">
                      <span class="persona-name">{{ segment.name }}</span>
                      <span class="persona-count">{{ segment.count }} Users</span>
                    </div>
                    <div class="progress-bar mini">
                      <div class="progress-fill" [style.width.%]="(segment.count / stats()?.uniqueVisitors) * 100"></div>
                    </div>
                  </div>
                }
              </div>
            </div>

            <div class="advanced-card">
              <h3>Predictive Insights</h3>
              <div class="predictive-stats">
                <div class="predict-item">
                  <span class="label">Next Day Forecast</span>
                  <span class="value">{{ stats()?.advancedMetrics?.predictive?.nextDayForecast }}</span>
                  <span class="sub">Est. Pageviews</span>
                </div>
                <div class="predict-item">
                  <span class="label">Lead Quality Score</span>
                  <span class="value">{{ stats()?.advancedMetrics?.predictive?.avgLeadQuality }}/100</span>
                  <div class="score-bar">
                    <div class="score-fill" [style.width.%]="stats()?.advancedMetrics?.predictive?.avgLeadQuality" [style.background]="getScoreColor(stats()?.advancedMetrics?.predictive?.avgLeadQuality)"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    } @else if (activeTab() === 'projects') {
      @if (isFormOpen()) {
        <section class="project-form">
          <h3>{{ editingId() ? 'Edit Project' : 'New Project' }}</h3>
          <form [formGroup]="projectForm" (ngSubmit)="saveProject()">
            <div class="form-grid">
              <div class="form-group">
                <label>Title</label>
                <input formControlName="title" placeholder="Project title">
              </div>
              <div class="form-group">
                <label>Completed Date</label>
                <input formControlName="completedDate" placeholder="e.g. June 2024">
              </div>
              <div class="form-group">
                <label>Tags (comma separated)</label>
                <input formControlName="tags" placeholder="UI/UX, Angular, NestJS">
              </div>
              <div class="form-group">
                <label>Main Image URL</label>
                <div class="input-with-action">
                  <input formControlName="imageUrl" placeholder="assets/images/...">
                  <button type="button" (click)="openMediaPicker('imageUrl')" class="btn btn-outline btn-sm">Pick</button>
                </div>
              </div>
              <div class="form-group">
                <label>Company Logo URL</label>
                <div class="input-with-action">
                  <input formControlName="companyLogo" placeholder="assets/images/...">
                  <button type="button" (click)="openMediaPicker('companyLogo')" class="btn btn-outline btn-sm">Pick</button>
                </div>
              </div>
              <div class="form-group">
                <label>Mockup URL</label>
                <div class="input-with-action">
                  <input formControlName="mockupUrl" placeholder="assets/images/...">
                  <button type="button" (click)="openMediaPicker('mockupUrl')" class="btn btn-outline btn-sm">Pick</button>
                </div>
              </div>
              <div class="form-group">
                <label>Gallery (comma separated URLs)</label>
                <div class="input-with-action">
                  <input formControlName="gallery" placeholder="url1, url2, url3">
                  <button type="button" (click)="openMediaPicker('gallery')" class="btn btn-outline btn-sm">Pick</button>
                </div>
              </div>
              <div class="form-group" style="flex-direction: row; align-items: center; gap: 1rem; padding-top: 1.5rem;">
                <label style="margin: 0;">Featured Project</label>
                <input type="checkbox" formControlName="isFeatured" style="width: auto;">
              </div>
              <div class="form-group">
                <label>Display Order</label>
                <input type="number" formControlName="order">
              </div>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Brief Description</label>
              <textarea formControlName="description" placeholder="A short summary of the project"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Challenge</label>
              <textarea formControlName="challenge"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Solution</label>
              <textarea formControlName="solution"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Result</label>
              <textarea formControlName="result"></textarea>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
              <label>Full Content (Markdown/HTML supported)</label>
              <textarea formControlName="content" style="min-height: 200px;"></textarea>
            </div>

            <div class="form-actions">
              <button type="button" (click)="closeForm()" class="btn btn-secondary">Cancel</button>
              <button type="submit" class="btn btn-primary" [disabled]="projectForm.invalid">
                {{ editingId() ? 'Update Project' : 'Create Project' }}
              </button>
            </div>
          </form>
        </section>
      }

      <div class="projects-management data-table-card">
        <h2>Manage Projects</h2>
        @if (projects().length > 0) {
          <table class="data-table">
            <thead>
              <tr>
                <th>Order</th>
                <th>Project Title</th>
                <th>Status</th>
                <th>Completed</th>
                <th>Tags</th>
                <th class="actions-cell">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (project of projects(); track project.id) {
                <tr>
                  <td>{{ project.order }}</td>
                  <td class="title-cell">
                    <strong>{{ project.title }}</strong>
                  </td>
                  <td>
                    @if (project.isFeatured) {
                      <span class="status-badge featured">Featured</span>
                    }
                  </td>
                  <td>{{ project.completedDate || 'N/A' }}</td>
                  <td>
                    <div class="mini-tags">
                      @if (project.tags) {
                        @for (tag of project.tags.slice(0, 2); track tag) {
                          <span class="mini-tag">{{ tag }}</span>
                        }
                        @if (project.tags.length > 2) {
                          <span class="mini-tag">+{{ project.tags.length - 2 }}</span>
                        }
                      } @else {
                        <span class="no-tags">No tags</span>
                      }
                    </div>
                  </td>
                  <td class="actions-cell">
                    <button (click)="openForm(project)" class="icon-btn edit" title="Edit">
                      <app-icon name="edit" [size]="16"></app-icon>
                    </button>
                    <button (click)='deleteProject(project.id)' class="icon-btn delete" title="Delete">
                      <app-icon name="trash" [size]="16"></app-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="empty-state">No projects found</div>
        }
      </div>
    } @else if (activeTab() === 'messages') {
      <div class="messages-management data-table-card">
        <h2>Inquiry Messages</h2>
        @if (messages().length > 0) {
          <table class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>From</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Message</th>
                <th class="actions-cell">Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (msg of messages(); track msg.id) {
                <tr [class.unread]="!msg.isRead">
                  <td class="date-cell">{{ msg.createdAt | date:'MMM d, y' }}</td>
                  <td class="from-cell">
                    <strong>{{ msg.name }}</strong>
                    <br>
                    <small>{{ msg.email }}</small>
                  </td>
                  <td>{{ msg.subject || 'No Subject' }}</td>
                  <td>
                    <select [value]="msg.status || 'new'" (change)="updateMessageStatus(msg.id, $any($event.target).value)" class="status-select" [attr.data-status]="msg.status">
                      <option value="new">New</option>
                      <option value="contacted">Contacted</option>
                      <option value="hired">Hired</option>
                      <option value="junk">Junk</option>
                    </select>
                  </td>
                  <td class="message-preview-cell">
                    <div class="message-text">{{ msg.message }}</div>
                  </td>
                  <td class="actions-cell">
                    @if (!msg.isRead) {
                      <button (click)="markMessageAsRead(msg.id)" class="icon-btn success" title="Mark as read">
                        <app-icon name="check" [size]="16"></app-icon>
                      </button>
                    }
                    <button (click)="deleteMessage(msg.id)" class="icon-btn delete" title="Delete">
                      <app-icon name="trash" [size]="16"></app-icon>
                    </button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        } @else {
          <div class="empty-state">No messages received yet</div>
        }
      </div>
    } @else if (activeTab() === 'settings') {
      <div class="settings-management data-table-card">
        <h2>Global Site Settings</h2>
        <form [formGroup]="settingsForm" (ngSubmit)="saveSettings()">
          <div class="form-section">
            <h3>Hero Section</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>Site Title</label>
                <input formControlName="siteTitle">
              </div>
              <div class="form-group">
                <label>Hero Title</label>
                <input formControlName="heroTitle">
              </div>
              <div class="form-group">
                <label>Hero Subtitle</label>
                <input formControlName="heroSubtitle">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>About & Bio</h3>
            <div class="form-group" style="margin-bottom: 1rem;">
              <label>Bio Lead Paragraph</label>
              <textarea formControlName="bioLead"></textarea>
            </div>
            <div class="form-group">
              <label>Full Bio Content</label>
              <textarea formControlName="bioFull" style="min-height: 150px;"></textarea>
            </div>
          </div>

          <div class="form-section">
            <h3>Technical Skills (comma separated)</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>Frontend Skills</label>
                <input formControlName="frontendSkills">
              </div>
              <div class="form-group">
                <label>Backend Skills</label>
                <input formControlName="backendSkills">
              </div>
              <div class="form-group">
                <label>Tools & DevOps</label>
                <input formControlName="toolSkills">
              </div>
            </div>
          </div>

          <div class="form-section">
            <h3>Social & Contact</h3>
            <div class="form-grid">
              <div class="form-group">
                <label>GitHub URL</label>
                <input formControlName="githubUrl">
              </div>
              <div class="form-group">
                <label>LinkedIn URL</label>
                <input formControlName="linkedinUrl">
              </div>
              <div class="form-group">
                <label>Public Email</label>
                <input formControlName="email">
              </div>
            </div>
          </div>

          <div class="form-actions" style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary">Save All Settings</button>
          </div>
        </form>
      </div>
    } @else if (activeTab() === 'media') {
      <div class="media-management data-table-card">
        <h2>Asset Library</h2>
        @if (mediaList().length > 0) {
          <div class="media-grid">
            @for (item of mediaList(); track item.id) {
              <div class="media-item">
                <div class="media-preview">
                  <img [src]="'http://localhost:3000' + item.url" [alt]="item.originalName">
                  <div class="media-overlay">
                    <button (click)="deleteMediaAsset(item.id)" class="icon-btn delete" title="Delete">
                      <app-icon name="trash" [size]="16"></app-icon>
                    </button>
                  </div>
                </div>
                <div class="media-info">
                  <span class="media-name">{{ item.originalName }}</span>
                  <span class="media-meta">{{ (item.size / 1024).toFixed(1) }} KB</span>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">No media assets uploaded yet</div>
        }
      </div>
    } @else if (activeTab() === 'help') {
      <div class="help-guide-section">
        <div class="help-hero data-table-card">
          <h1>Dashboard Help Guide</h1>
          <p>Welcome to your personal command center. This guide explains how to use the analytics, content management, and lead tracking features of your portfolio dashboard.</p>
        </div>

        <div class="help-grid">
          <div class="help-card data-table-card">
            <div class="help-icon"><app-icon name="chart" [size]="24"></app-icon></div>
            <h3>Analytics Deep-Dive</h3>
            <ul>
              <li><strong>Live Mode:</strong> Real-time traffic polling (updates every 5s). Ideal for monitoring active campaigns.</li>
              <li><strong>Comparison:</strong> Toggle to see percentage changes (delta) against the previous period.</li>
              <li><strong>Acquisition:</strong> Understand where your traffic comes from (Direct, Social, Organic, etc.).</li>
              <li><strong>UX Tracking:</strong> <em>Rage Clicks</em> highlight elements where users clicked rapidly (frustration points). <em>Scroll Depth</em> shows how far users read.</li>
              <li><strong>Performance:</strong> Monitor Core Web Vitals (LCP, FID, CLS) to ensure your site is fast and stable.</li>
            </ul>
          </div>

          <div class="help-card data-table-card">
            <div class="help-icon"><app-icon name="briefcase" [size]="24"></app-icon></div>
            <h3>Project Management</h3>
            <ul>
              <li><strong>Dynamic Content:</strong> Add or edit case studies with rich text support.</li>
              <li><strong>Featured Status:</strong> Toggling "Featured" puts the project in the homepage spotlight.</li>
              <li><strong>Visuals:</strong> Use the <em>Media Library</em> to pick images for hero sections and galleries.</li>
              <li><strong>Challenge/Solution:</strong> Structured fields to ensure consistent case study storytelling.</li>
            </ul>
          </div>

          <div class="help-card data-table-card">
            <div class="help-icon"><app-icon name="mail" [size]="24"></app-icon></div>
            <h3>Lead Lifecycle</h3>
            <ul>
              <li><strong>Message Tracking:</strong> New submissions appear with a notification badge.</li>
              <li><strong>Status Workflow:</strong> Track leads from <em>New</em> → <em>Contacted</em> → <em>Hired</em>. Use <em>Junk</em> to filter noise.</li>
              <li><strong>Retention:</strong> Use the <em>Cohort Analysis</em> in Analytics to see how often leads return to the site.</li>
            </ul>
          </div>

          <div class="help-card data-table-card">
            <div class="help-icon"><app-icon name="settings" [size]="24"></app-icon></div>
            <h3>Advanced Tools</h3>
            <ul>
              <li><strong>Timeline Notes:</strong> Click the "Plus" on the Activity Chart to add annotations (e.g., "Launched Blog").</li>
              <li><strong>Sharing:</strong> Generate secure, read-only links to share these analytics with others without giving them your password.</li>
              <li><strong>API Keys:</strong> Generate tokens for external integrations or custom reporting tools.</li>
              <li><strong>Site Settings:</strong> Instantly update your bio, skills, and social links across the entire site.</li>
            </ul>
          </div>
        </div>
      </div>
    }
  </div>

  @if (isMediaPickerOpen()) {
    <div class="modal-overlay" (click)="closeMediaPicker()">
      <div class="modal-content media-picker-modal" (click)="$event.stopPropagation()">
        <header class="modal-header">
          <h3>Select Media</h3>
          <button (click)="closeMediaPicker()" class="icon-btn">
            <app-icon name="close" [size]="20"></app-icon>
          </button>
        </header>
        <div class="modal-body">
          @if (mediaList().length > 0) {
            <div class="media-grid picker">
              @for (item of mediaList(); track item.id) {
                <div class="media-item" (click)="selectMediaForProject(item.url)">
                  <div class="media-preview">
                    <img [src]="'http://localhost:3000' + item.url" [alt]="item.originalName">
                  </div>
                  <div class="media-info">
                    <span class="media-name">{{ item.originalName }}</span>
                  </div>
                </div>
              }
            </div>
          } @else {
            <div class="empty-state">
              <p>No assets found.</p>
              <label class="btn btn-primary btn-sm" style="cursor: pointer; margin-top: 1rem;">
                Upload First
                <input type="file" (change)="onFileUpload($event)" style="display: none;" accept="image/*">
              </label>
            </div>
          }
        </div>
      </div>
    </div>
  }
</div>
